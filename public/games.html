<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Games - Nexus Revived">
    <meta name="theme-color" content="#050505">
    <title>Games - Nexus Revived</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .game-card { background: rgba(0,230,118,0.05); border: 1px solid rgba(0,230,118,0.2); border-radius: 12px; overflow: hidden; transition: all 0.3s; cursor: pointer; }
        .game-card:hover { border-color: var(--primary); box-shadow: 0 0 20px rgba(0,230,118,0.2); transform: translateY(-2px); }
        .game-card-header { padding: 15px; background: rgba(0,230,118,0.1); border-bottom: 1px solid rgba(0,230,118,0.2); display: flex; justify-content: space-between; align-items: center; }
        .game-card-title { color: var(--primary); font-weight: 600; margin: 0; flex: 1; word-break: break-word; display: flex; align-items: center; gap: 10px; }
        .game-card-icon { width: 24px; height: 24px; object-fit: contain; }
        .game-card-actions { display: flex; gap: 8px; }
        .game-card-btn { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .game-card-btn:hover { transform: scale(1.2); }
        .game-card-btn.pinned { color: #FFD700; }
        .game-card-iframe { width: 100%; height: 400px; border: none; }
        .game-card-footer { padding: 10px 15px; background: rgba(0,0,0,0.3); text-align: center; color: #aaa; font-size: 0.85rem; cursor: pointer; }
        .game-card-footer:hover { color: var(--primary); }
        .search-bar { width: 100%; padding: 12px 15px; background: rgba(0,230,118,0.05); border: 1px solid rgba(0,230,118,0.2); border-radius: 8px; color: #fff; font-size: 1rem; margin-bottom: 20px; }
        .search-bar::placeholder { color: rgba(255,255,255,0.5); }
        .search-bar:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,230,118,0.2); }
        .pinned-section { margin-bottom: 30px; }
        .pinned-section h3 { color: #FFD700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 15px 0; }
        
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.95); z-index: 9999; display: none; flex-direction: column; }
        .fullscreen-modal.active { display: flex; }
        .fullscreen-header { background: rgba(0,230,118,0.1); border-bottom: 1px solid rgba(0,230,118,0.2); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .fullscreen-title { color: var(--primary); font-size: 1.2rem; font-weight: 600; margin: 0; }
        .close-btn { background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .close-btn:hover { background: #ff3838; }
        .fullscreen-content { flex: 1; overflow: hidden; position: relative; }
        .fullscreen-iframe { width: 100%; height: 100%; border: none; }
        
        .floating-chat { position: absolute; bottom: 20px; right: 20px; width: 300px; height: 400px; background: rgba(5,5,5,0.95); border: 1px solid rgba(0,230,118,0.3); border-radius: 12px; display: flex; flex-direction: column; resize: both; overflow: hidden; touch-action: none; z-index: 10000; }
        .floating-chat-header { background: rgba(0,230,118,0.1); border-bottom: 1px solid rgba(0,230,118,0.2); padding: 12px; cursor: move; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .floating-chat-title { color: var(--primary); font-weight: 600; font-size: 0.9rem; margin: 0; }
        .floating-chat-close { background: none; border: none; color: #ff4757; cursor: pointer; font-size: 1.2rem; }
        .floating-chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .chat-message { padding: 8px 10px; background: rgba(0,230,118,0.1); border-radius: 6px; color: #ccc; font-size: 0.85rem; border-left: 2px solid var(--primary); }
        .chat-message.system { border-left-color: #aaa; color: #aaa; background: rgba(100,100,100,0.1); }
        .floating-chat-input { padding: 10px; border-top: 1px solid rgba(0,230,118,0.2); }
        .floating-chat-input input { width: 100%; padding: 6px 8px; background: rgba(0,230,118,0.05); border: 1px solid rgba(0,230,118,0.2); border-radius: 4px; color: #fff; font-size: 0.9rem; }
        .floating-chat-input input::placeholder { color: rgba(255,255,255,0.4); }
        .floating-chat-input input:focus { outline: none; border-color: var(--primary); }
    </style>
</head>
<body id="page-games">
    <canvas id="particleCanvas"></canvas>
    <div class="app-container">
        <header class="dashboard-header fade-in">
            <div class="brand">
                <i class="fas fa-gamepad" style="color: var(--primary);"></i> Games
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="window.location.href='index.html'" class="btn-danger" style="min-width: 120px; font-size: 0.95rem;">
                    <i class="fas fa-home"></i> Home
                </button>
            </div>
        </header>
        <div id="notifications-container" style="position: fixed; top: 80px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; max-width: 400px;"></div>
        <main class="glass-panel" style="padding: 20px; min-height: 60vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary); margin: 0;">Game Library</h2>
                <button id="upload-game-btn" class="btn-glow" onclick="document.getElementById('upload-game-file').click();" style="display: none;">
                    <i class="fas fa-upload"></i> Upload Game
                </button>
            </div>
            
            <div id="game-upload-zone" style="border: 2px dashed rgba(0,230,118,0.3); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 20px; transition: all 0.3s; display: none;">
                <i class="fas fa-cloud-upload-alt" style="color: var(--primary); font-size: 1.5rem; margin-bottom: 8px;"></i>
                <p style="color: #aaa; margin: 0;">Drag & drop HTML file here or click to select</p>
            </div>
            <input type="file" id="upload-game-file" accept=".html" style="display: none;">
            
            <input type="text" id="search-games" placeholder="ðŸ” Search games..." class="search-bar">
            
            <div id="pinned-games-container" class="pinned-section" style="display: none;">
                <h3><i class="fas fa-thumbtack"></i> Pinned Games</h3>
                <div id="pinned-games" class="game-grid"></div>
            </div>
            
            <div>
                <h3 style="color: #aaa; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 15px 0;">All Games</h3>
                <div id="games-list" class="game-grid"></div>
            </div>
            
            <div id="no-games-msg" style="text-align: center; color: #666; padding: 40px 20px; display: none;">
                <i class="fas fa-gamepad" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>No games found. Upload one to get started!</p>
            </div>
        </main>
    </div>

    <!-- Fullscreen Game Modal -->
    <div id="fullscreen-modal" class="fullscreen-modal">
        <div class="fullscreen-header">
            <h2 class="fullscreen-title" id="fullscreen-title">Game</h2>
            <button class="close-btn" onclick="closeFullscreenGame()">âœ• Close</button>
        </div>
        <div class="fullscreen-content">
            <iframe id="fullscreen-iframe" class="fullscreen-iframe"></iframe>
            <div id="floating-chat" class="floating-chat">
                <div class="floating-chat-header">
                    <h3 class="floating-chat-title">Chat</h3>
                    <button class="floating-chat-close" onclick="closeFloatingChat()">âœ•</button>
                </div>
                <div id="floating-chat-messages" class="floating-chat-messages"></div>
                <div class="floating-chat-input">
                    <input type="text" id="floating-chat-input" placeholder="Type message..." onkeypress="handleFloatingChatInput(event)">
                </div>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="particles.js"></script>
    <script src="script.js"></script>
    <script>
        // Games page specific logic
        let allGames = [];
        let pinnedGames = JSON.parse(localStorage.getItem('pinnedGames') || '[]');
        let gameIcons = JSON.parse(localStorage.getItem('gameIcons') || '{}');
        
        // Extract favicon from HTML content
        function extractIcon(htmlContent) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const icons = doc.querySelectorAll('link[rel*="icon"]');
                for (let icon of icons) {
                    const href = icon.getAttribute('href');
                    if (href) {
                        // Handle relative URLs
                        if (href.startsWith('http')) return href;
                        if (href.startsWith('data:')) return href;
                    }
                }
            } catch (e) {}
            return null;
        }
        
        function renderGames() {
            const list = document.getElementById('games-list');
            const pinnedContainer = document.getElementById('pinned-games-container');
            const pinnedList = document.getElementById('pinned-games');
            const noGamesMsg = document.getElementById('no-games-msg');
            const search = document.getElementById('search-games')?.value.toLowerCase() || '';
            
            // Filter games by search
            const filteredGames = allGames.filter(name => name.toLowerCase().includes(search));
            
            // Render pinned games
            if (pinnedGames.length > 0) {
                pinnedContainer.style.display = 'block';
                pinnedList.innerHTML = '';
                pinnedGames.forEach(name => {
                    if (allGames.includes(name)) {
                        pinnedList.appendChild(createGameCard(name, true));
                    }
                });
            } else {
                pinnedContainer.style.display = 'none';
            }
            
            // Render all games (excluding pinned)
            list.innerHTML = '';
            const unpinnedGames = filteredGames.filter(g => !pinnedGames.includes(g));
            
            if (unpinnedGames.length === 0 && filteredGames.length === 0) {
                noGamesMsg.style.display = 'block';
            } else {
                noGamesMsg.style.display = 'none';
                unpinnedGames.forEach(name => {
                    list.appendChild(createGameCard(name, false));
                });
            }
        }
        
        function createGameCard(name, isPinned) {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            const icon = gameIcons[name];
            const iconHtml = icon ? `<img src="${icon}" class="game-card-icon" alt="${name}" onerror="this.style.display='none'">` : '';
            
            card.innerHTML = `
                <div class="game-card-header">
                    <h3 class="game-card-title">
                        ${iconHtml}
                        <span>${name.replace('.html', '')}</span>
                    </h3>
                    <div class="game-card-actions">
                        ${currentUser && currentUser.isAdmin ? `
                            <button class="game-card-btn ${isPinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePin('${name}')" title="${isPinned ? 'Unpin' : 'Pin'}">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <button class="game-card-btn" onclick="event.stopPropagation(); deleteGame('${name}')" title="Delete" style="color: #ff4757;">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
                <iframe class="game-card-iframe" src="/games/${encodeURIComponent(name)}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
                <div class="game-card-footer" onclick="openFullscreenGame('${name}')">
                    <i class="fas fa-expand"></i> Play Fullscreen
                </div>
            `;
            
            // Load and cache game icon on first load
            if (!gameIcons[name]) {
                fetch('/games/' + encodeURIComponent(name))
                    .then(r => r.text())
                    .then(html => {
                        const icon = extractIcon(html);
                        if (icon) {
                            gameIcons[name] = icon;
                            localStorage.setItem('gameIcons', JSON.stringify(gameIcons));
                            renderGames(); // Re-render to show icon
                        }
                    })
                    .catch(e => console.log('Could not load game icon:', e));
            }
            
            return card;
        }
        
        function togglePin(name) {
            if (pinnedGames.includes(name)) {
                pinnedGames = pinnedGames.filter(g => g !== name);
            } else {
                pinnedGames.push(name);
            }
            localStorage.setItem('pinnedGames', JSON.stringify(pinnedGames));
            renderGames();
        }
        
        function deleteGame(name) {
            if (confirm('Delete game: ' + name + '?')) {
                socket.emit('adminDeleteGame', { filename: name });
            }
        }
        
        function fetchGames() {
            fetch('/api/games')
                .then(r => r.json())
                .then(data => {
                    allGames = data.games;
                    renderGames();
                })
                .catch(e => {
                    console.error('Error fetching games:', e);
                    showNotification('Failed to load games', 'error');
                });
        }
        
        // Fullscreen game viewer
        function openFullscreenGame(name) {
            const modal = document.getElementById('fullscreen-modal');
            const iframe = document.getElementById('fullscreen-iframe');
            const title = document.getElementById('fullscreen-title');
            
            title.textContent = name.replace('.html', '');
            iframe.src = '/games/' + encodeURIComponent(name);
            modal.classList.add('active');
            
            // Add system message to chat
            addChatMessage(`Game "${name.replace('.html', '')}" started`, 'system');
        }
        
        function closeFullscreenGame() {
            const modal = document.getElementById('fullscreen-modal');
            const iframe = document.getElementById('fullscreen-iframe');
            modal.classList.remove('active');
            iframe.src = '';
            document.getElementById('floating-chat-messages').innerHTML = '';
        }
        
        // Floating chat functionality
        let chatMessages = [];
        
        function addChatMessage(text, type = 'user', username = null) {
            const messagesContainer = document.getElementById('floating-chat-messages');
            const msg = document.createElement('div');
            msg.className = `chat-message ${type === 'system' ? 'system' : ''}`;
            
            if (type === 'system') {
                msg.textContent = text;
            } else {
                msg.innerHTML = `<strong>${username || currentUser.username}:</strong> ${text}`;
            }
            
            messagesContainer.appendChild(msg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            chatMessages.push({text, type, username});
        }
        
        function handleFloatingChatInput(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('floating-chat-input');
                const text = input.value.trim();
                if (text) {
                    addChatMessage(text, 'user');
                    socket.emit('chatMessage', text);
                    input.value = '';
                }
            }
        }
        
        function closeFloatingChat() {
            document.getElementById('floating-chat').style.display = 'none';
        }
        
        // Make floating chat resizable and draggable
        const floatingChat = document.getElementById('floating-chat');
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        document.querySelector('.floating-chat-header').addEventListener('mousedown', (e) => {
            isDragging = true;
            dragOffsetX = e.clientX - floatingChat.offsetLeft;
            dragOffsetY = e.clientY - floatingChat.offsetTop;
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                floatingChat.style.left = (e.clientX - dragOffsetX) + 'px';
                floatingChat.style.top = (e.clientY - dragOffsetY) + 'px';
                floatingChat.style.right = 'auto';
                floatingChat.style.bottom = 'auto';
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        // Listen for incoming messages
        socket.on('message', (msgObj) => {
            if (document.getElementById('fullscreen-modal').classList.contains('active')) {
                if (msgObj.user) {
                    addChatMessage(msgObj.text, 'message', msgObj.user);
                }
            }
        });
        
        // Show upload for admins
        if (currentUser && currentUser.isAdmin) {
            document.getElementById('upload-game-btn').style.display = 'flex';
            document.getElementById('game-upload-zone').style.display = 'block';
        }
        
        // Trigger file selection on zone click
        const zone = document.getElementById('game-upload-zone');
        const fileInput = document.getElementById('upload-game-file');
        if (zone && fileInput) {
            zone.onclick = () => fileInput.click();
            
            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                zone.addEventListener(evt, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            ['dragenter', 'dragover'].forEach(evt => {
                zone.addEventListener(evt, () => {
                    zone.style.backgroundColor = 'rgba(0, 230, 118, 0.1)';
                    zone.style.borderColor = 'var(--primary)';
                });
            });
            
            ['dragleave', 'drop'].forEach(evt => {
                zone.addEventListener(evt, () => {
                    zone.style.backgroundColor = '';
                    zone.style.borderColor = '';
                });
            });
            
            zone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file && file.name.toLowerCase().endsWith('.html')) {
                    fileInput.files = e.dataTransfer.files;
                    document.getElementById('upload-game-btn')?.click?.();
                } else {
                    showNotification('Please drop an HTML file', 'error');
                }
            });
        }
        
        // Search functionality
        const searchInput = document.getElementById('search-games');
        if (searchInput) {
            searchInput.addEventListener('input', renderGames);
        }
        
        // Real-time updates
        socket.on('newGameUploaded', () => {
            fetchGames();
            showNotification('New game added!', 'success');
        });
        
        socket.on('gameDeleted', () => {
            fetchGames();
            showNotification('Game deleted', 'success');
        });
        
        socket.on('adminActionResponse', (data) => {
            if (data.success) {
                showNotification(data.message, 'success');
            } else {
                showNotification(data.message, 'error');
            }
        });
        
        // Initial load
        fetchGames();
    </script>
</body>
</html>